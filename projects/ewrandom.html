<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link
      rel="icon"
      type="image/png"
      href="https://user-images.githubusercontent.com/36041339/119904829-a8cb0400-bf53-11eb-8e85-6ad4db044b36.png"
    />
    <link
      rel="shortcut icon"
      sizes="196x196"
      href="https://user-images.githubusercontent.com/36041339/119904829-a8cb0400-bf53-11eb-8e85-6ad4db044b36.png"
    />
    <link
      rel="apple-touch-icon"
      sizes="128x128"
      href="https://user-images.githubusercontent.com/36041339/119904829-a8cb0400-bf53-11eb-8e85-6ad4db044b36.png"
    />
    <link
      rel="apple-touch-icon"
      href="https://user-images.githubusercontent.com/36041339/119904829-a8cb0400-bf53-11eb-8e85-6ad4db044b36.png"
    />

    <meta
      name="msapplication-TileImage"
      content="https://user-images.githubusercontent.com/36041339/119904829-a8cb0400-bf53-11eb-8e85-6ad4db044b36.png"
    />
    <link
      rel="apple-touch-icon-precomposed"
      sizes="128x128"
      href="https://user-images.githubusercontent.com/36041339/119904829-a8cb0400-bf53-11eb-8e85-6ad4db044b36.png"
    />

    <meta name="mobile-web-app-capable" content="yes" />
    <title>EwRandom</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <style>
      body {
        background-color: #182952;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        height: calc(100vh - 18px);
        overflow: hidden;
      }
      .btn {
        background-color: #7045af;
        color: white;
        padding: 24px;
        min-width: 120px;
        max-width: 200px;
        font-size: 24px;
        font-weight: bold;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        user-select: none;
        margin-bottom: 16px;
      }

      .btn:active {
        background-color: #5d3698;
        box-shadow: none;
      }
      body.hide {
        pointer-events: none;
        opacity: 0.5;
      }
    </style>
  </head>
  <body class="hide">
    <div onclick="random()" class="btn" id="random">Random</div>
    <div onclick="increase()" class="btn" id="increase">-</div>
    <div onclick="edit()" class="btn" id="edit">Duzenle</div>

    <script>
      const url = "https://api.npoint.io/04043f16a9775a48c8ca";

      const increaseButton = document.getElementById("increase");
      const randomButton = document.getElementById("random");

      const WORD_COUNT_PER_PAGE = 8;
      const UNUSED_PAGE = 1;

      const practicedSentences = [];
      let count = new Number(0);
      let lastRandomDate = undefined;
      function update() {
        fetch(url, {
          method: "POST",
          body: JSON.stringify({
            count,
            practicedSentences,
            lastRandomDate
          })
        });
      }

      practicedSentences.update = newSentences => {
        practicedSentences.push(...newSentences);
        practicedSentences.sort((a, b) => a - b);
        update();
      };
      practicedSentences.clear = () => {
        practicedSentences.length = 0;
        update();
      };

      const updateCount = newValue => {
        count = new Number(newValue);
        count.update = updateCount;

        increaseButton.innerText = `${print(count)}`;
        document.body.classList.remove("hide");

        update();
      };
      count.update = updateCount;

      function print(c) {
        const divided = c / WORD_COUNT_PER_PAGE;
        const page = Math.ceil(divided);
        const wordCountRate = divided - Math.floor(divided);
        const wordIndex =
          (wordCountRate === 0 ? 1 : wordCountRate) * WORD_COUNT_PER_PAGE;

        return `${page + UNUSED_PAGE}. sayfa ${wordIndex}. cumle`;
      }

      function edit() {
        let value = prompt("Sayi gir");
        if (value === null) {
          alert("Please enter a value");
          return;
        }

        if (value.indexOf(".") > -1) {
          const [page, c] = value.split(".");

          const pageValue =
            (parseInt(page, 10) - (1 + UNUSED_PAGE)) * WORD_COUNT_PER_PAGE;

          count.update(pageValue + parseInt(c, 10));
          return;
        }

        count.update(parseInt(value, 10));
      }

      function random() {
        // dont show last 5 sentence
        lastRandomDate = new Date();
        const all = Array(count - 5)
          .fill(0)
          .map((_, i) => i + 1);

        let available = all.filter(i => practicedSentences.indexOf(i) === -1);

        if (available.length < 3) {
          practicedSentences.clear();
          available = all;
        }
        const sentenceIndexes = Array.from(available)
          // shuffle
          .sort(() => 0.5 - Math.random())
          .sort(() => 0.5 - Math.random())
          .sort(() => 0.5 - Math.random())

          // pick 3 sentence
          .slice(0, 3);

        practicedSentences.update(sentenceIndexes);

        const message = sentenceIndexes.map(print).join("\n");
        alert(message);
      }

      function increase() {
        count.update(count + 1);
      }

      fetch(url)
        .then(i => i.json())
        .then(data => {
          count.update(data.count);
          const diffDay = (new Date() - new Date(data.lastRandomDate)) / 8.64e7;
          if (diffDay < 5) {
            practicedSentences.update(data.practicedSentences);
          }
        });
    </script>
  </body>
</html>
